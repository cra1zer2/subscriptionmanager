<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubManager | Dashboard</title>

    <!-- Dependencies: React, Babel, Tailwind, Fonts, Icons -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Base Layout & Theme */
        body {
            background: radial-gradient(circle at 50% -20%, #1e1b4b, #0f172a, #020617);
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }

        /* Glassmorphism Utility Class */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Custom Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popUp {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .anim-fade { animation: fadeIn 0.2s ease-out forwards; }
        .anim-pop { animation: popUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .anim-toast { animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .tabular-nums { font-variant-numeric: tabular-nums; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

<div id="root" class="w-full max-w-6xl relative z-10"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    /**
     * Hook: Locks body scroll when a modal is open.
     */
    const useScrollLock = (isLocked) => {
        useEffect(() => {
            document.body.style.overflow = isLocked ? 'hidden' : 'unset';
            return () => { document.body.style.overflow = 'unset'; }
        }, [isLocked]);
    };

    /**
     * Component: Modal to confirm deletion.
     * Z-Index: 100 (High priority)
     * Position: Fixed to Viewport.
     */
    const ConfirmModal = ({ isOpen, onCancel, onConfirm }) => {
        useScrollLock(isOpen);
        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                {/* Backdrop: Covers full screen */}
                <div className="fixed inset-0 bg-[#020617]/80 backdrop-blur-sm anim-fade" onClick={onCancel}></div>

                {/* Modal Content: Added mb-24 to push it upwards visually */}
                <div className="relative glass bg-[#0f172a] w-full max-w-[380px] rounded-2xl p-8 text-center anim-pop border border-white/10 shadow-2xl z-[101] mb-24">
                    <div className="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-5 border border-red-500/20 shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                        <i className="fa-solid fa-triangle-exclamation text-2xl text-red-500"></i>
                    </div>
                    <h3 className="text-2xl font-bold text-white mb-2 tracking-tight">Stop Subscription?</h3>
                    <p className="text-slate-400 text-sm mb-8 leading-relaxed px-2">
                        Are you sure you want to delete this? <br/>
                        This action cannot be undone.
                    </p>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={onCancel} className="py-3.5 rounded-xl bg-white/5 hover:bg-white/10 text-sm font-semibold transition-colors text-slate-300">
                            Cancel
                        </button>
                        <button onClick={onConfirm} className="py-3.5 rounded-xl bg-red-600 hover:bg-red-500 text-white text-sm font-semibold shadow-lg shadow-red-900/20 border border-red-500/20 active:scale-95 transition-transform">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    /**
     * Component: Modal to add new subscription.
     * Z-Index: 100
     */
    const AddModal = ({ isOpen, onClose, onSave }) => {
        useScrollLock(isOpen);
        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                {/* Backdrop */}
                <div className="fixed inset-0 bg-[#020617]/80 backdrop-blur-sm anim-fade" onClick={onClose}></div>

                {/* Content */}
                <div className="relative glass bg-[#0f172a] w-full max-w-[420px] rounded-2xl p-8 anim-pop border border-white/10 z-[101] shadow-2xl">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-bold text-white tracking-tight">Add Subscription</h2>
                        <button onClick={onClose} className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/10 transition-colors">
                            <i className="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <form onSubmit={onSave} className="space-y-6">
                        <div>
                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Service Name</label>
                            <input name="providerName" required autoFocus placeholder="e.g. Netflix Premium"
                                   className="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-4 text-base text-white focus:outline-none focus:border-indigo-500 focus:bg-black/50 transition-all placeholder-white/20" />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Amount</label>
                                <input type="number" name="amount" step="0.01" required placeholder="0.00"
                                       className="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-4 text-base text-white focus:outline-none focus:border-indigo-500 focus:bg-black/50 transition-all tabular-nums placeholder-white/20" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Currency</label>
                                <div className="relative">
                                    <select name="currency" className="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-4 text-base text-white focus:outline-none focus:border-indigo-500 focus:bg-black/50 transition-all appearance-none cursor-pointer">
                                        <option value="PLN">PLN</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                    </select>
                                    <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                                        <i className="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" className="w-full py-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm font-bold uppercase tracking-widest text-white shadow-lg shadow-indigo-900/30 transition-all active:scale-[0.98] mt-2 border border-indigo-400/20">
                            Save Subscription
                        </button>
                    </form>
                </div>
            </div>
        );
    }

    /**
     * Component: Toast Notification.
     * Position: Fixed top center of viewport.
     */
    const Toast = ({ msg }) => (
        <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[200] anim-toast pointer-events-none w-max">
            <div className="glass bg-[#064e3b]/90 border border-emerald-500/30 rounded-full px-8 py-3.5 flex items-center gap-3 shadow-[0_10px_40px_-10px_rgba(16,185,129,0.5)] backdrop-blur-xl">
                <div className="bg-emerald-500 rounded-full w-6 h-6 flex items-center justify-center shadow-lg shadow-emerald-500/40">
                    <i className="fa-solid fa-check text-xs text-white"></i>
                </div>
                <span className="text-sm font-bold text-white tracking-wide">{msg}</span>
            </div>
        </div>
    );

    /**
     * Main App Container
     */
    const App = () => {
        // State Management
        const [subs, setSubs] = useState([]);
        const [total, setTotal] = useState("0.00");
        const [showAdd, setShowAdd] = useState(false);
        const [deleteId, setDeleteId] = useState(null);
        const [toastMsg, setToastMsg] = useState(null);

        // Weather State
        const [weather, setWeather] = useState({
            temp: "--",
            desc: "Loading",
            icon: "fa-cloud",
            humidity: "--",
            wind: "--"
        });

        // Fetch backend data
        const fetchData = async () => {
            try {
                const res = await fetch('/api/v1/subscriptions');
                if(res.ok) {
                    const data = await res.json();
                    setSubs(data);
                }
                const tRes = await fetch('/api/v1/subscriptions/total');
                if(tRes.ok) {
                    const tData = await tRes.json();
                    setTotal(tData.toFixed(2));
                }
            } catch (e) {
                console.warn("Backend unavailable, using mock/empty state.");
            }
        };

        // Initialize Weather API (OpenMeteo)
        const initWeather = () => {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const { latitude, longitude } = pos.coords;
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code,relative_humidity_2m,wind_speed_10m`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const current = data.current;

                    // Map WMO codes to icons
                    const code = current.weather_code;
                    let icon = "fa-cloud";
                    let desc = "Cloudy";
                    if (code === 0) { icon = "fa-sun"; desc = "Clear"; }
                    else if (code >= 51 && code <= 82) { icon = "fa-cloud-showers-heavy"; desc = "Rain"; }
                    else if (code >= 71) { icon = "fa-snowflake"; desc = "Snow"; }

                    setWeather({
                        temp: Math.round(current.temperature_2m),
                        desc,
                        icon,
                        humidity: current.relative_humidity_2m,
                        wind: Math.round(current.wind_speed_10m)
                    });
                } catch(e) { console.error("Weather fetch failed", e); }
            });
        };

        useEffect(() => {
            fetchData();
            initWeather();
        }, []);

        // Logic: Add Subscription
        const handleAdd = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const body = Object.fromEntries(formData.entries());
            body.nextPaymentDate = "2026-03-01"; // Default logic

            try {
                const res = await fetch('/api/v1/subscriptions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if(res.ok){
                    setShowAdd(false);
                    fetchData();
                    showToast("Subscription Added Successfully");
                }
            } catch(e) { console.error(e); }
        };

        // Logic: Delete Subscription
        const handleDelete = async () => {
            try {
                await fetch(`/api/v1/subscriptions/${deleteId}`, { method: 'DELETE' });
                setDeleteId(null);
                fetchData();
                showToast("Subscription Deleted");
            } catch(e) { console.error(e); }
        };

        // Logic: Show Toast
        const showToast = (msg) => {
            setToastMsg(msg);
            setTimeout(() => setToastMsg(null), 3000);
        };

        return (
            <div className="w-full flex flex-col lg:flex-row gap-8 anim-fade">

                {/* --- LEFT SIDEBAR --- */}
                <aside className="w-full lg:w-[300px] flex flex-col gap-6 shrink-0">

                    {/* Widget: Monthly Cost */}
                    <div className="glass rounded-[2rem] p-8 relative overflow-hidden flex flex-col justify-between min-h-[180px]">
                        <div>
                            <div className="text-xs font-bold text-indigo-300/80 uppercase tracking-widest mb-3">Monthly Cost</div>
                            <div className="flex items-baseline gap-2">
                                <span className="text-6xl font-bold text-white tabular-nums tracking-tight drop-shadow-lg">{total}</span>
                                <span className="text-lg font-semibold text-slate-500">PLN</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 mt-4">
                            <span className="relative flex h-2.5 w-2.5">
                              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                              <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
                            </span>
                            <span className="text-[10px] font-bold text-emerald-400/90 uppercase tracking-widest">Live NBP Rates</span>
                        </div>
                    </div>

                    {/* Widget: Weather */}
                    <div className="glass rounded-[2rem] p-8 flex flex-col items-center relative overflow-hidden">
                        <div className="flex flex-col items-center justify-center py-2">
                            <i className={`fa-solid ${weather.icon} text-6xl text-white mb-4 drop-shadow-[0_0_25px_rgba(255,255,255,0.3)]`}></i>
                            <div className="text-5xl font-bold text-white tracking-tight">{weather.temp}Â°</div>
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-2">{weather.desc}</div>
                        </div>

                        <div className="w-full h-px bg-gradient-to-r from-transparent via-white/10 to-transparent my-6"></div>

                        <div className="w-full grid grid-cols-2 gap-4">
                            <div className="flex flex-col items-center group">
                                <div className="text-indigo-400 mb-1 group-hover:scale-110 transition-transform"><i className="fa-solid fa-wind"></i></div>
                                <span className="text-white font-bold text-lg">{weather.wind} <span className="text-xs font-normal text-slate-500">km/h</span></span>
                            </div>
                            <div className="flex flex-col items-center border-l border-white/5 group">
                                <div className="text-blue-400 mb-1 group-hover:scale-110 transition-transform"><i className="fa-solid fa-droplet"></i></div>
                                <span className="text-white font-bold text-lg">{weather.humidity}<span className="text-xs font-normal text-slate-500">%</span></span>
                            </div>
                        </div>
                    </div>
                </aside>

                {/* --- MAIN CONTENT AREA --- */}
                <main className="flex-1 flex flex-col">
                    <div className="flex justify-between items-end mb-8 px-2">
                        <div>
                            <h1 className="text-4xl font-extrabold text-white tracking-tight mb-2">Subscriptions</h1>
                            <p className="text-slate-400 text-sm font-medium opacity-80">Manage your recurring services</p>
                        </div>
                        <button
                            onClick={() => setShowAdd(true)}
                            className="bg-indigo-600 hover:bg-indigo-500 text-white pl-6 pr-7 py-3.5 rounded-2xl text-xs font-bold uppercase tracking-widest shadow-[0_10px_20px_-5px_rgba(79,70,229,0.4)] transition-all active:scale-95 flex items-center gap-2.5 border border-indigo-400/20 group">
                            <i className="fa-solid fa-plus text-sm group-hover:rotate-90 transition-transform duration-300"></i>
                            <span>New Entry</span>
                        </button>
                    </div>

                    <div className="glass rounded-[2rem] overflow-hidden flex-1 relative min-h-[500px] flex flex-col pb-4">
                        <table className="w-full text-left border-collapse">
                            <thead>
                            <tr className="border-b border-white/5 bg-white/[0.02]">
                                <th className="py-6 px-8 text-xs font-bold text-slate-500 uppercase tracking-widest w-[35%]">Service</th>
                                <th className="py-6 px-8 text-xs font-bold text-slate-500 uppercase tracking-widest text-right w-[25%]">Amount</th>
                                <th className="py-6 px-8 text-xs font-bold text-slate-500 uppercase tracking-widest text-center w-[20%]">Currency</th>
                                <th className="py-6 px-8 text-xs font-bold text-slate-500 uppercase tracking-widest text-center w-[20%]">Action</th>
                            </tr>
                            </thead>
                            <tbody className="divide-y divide-white/5">
                            {subs.length === 0 ? (
                                <tr>
                                    <td colSpan="4" className="py-32 text-center text-slate-600">
                                        <i className="fa-solid fa-ghost text-4xl mb-4 opacity-50"></i>
                                        <div className="text-xs font-bold uppercase tracking-widest opacity-60">No Data</div>
                                    </td>
                                </tr>
                            ) : subs.map(s => (
                                <tr key={s.id} className="hover:bg-white/[0.03] transition-colors group">
                                    <td className="py-6 px-8">
                                        <div className="font-semibold text-slate-200 text-lg tracking-wide">{s.providerName}</div>
                                    </td>
                                    <td className="py-6 px-8 text-right">
                                        <div className="font-mono font-bold text-emerald-400 tabular-nums text-xl tracking-tight">{s.amount.toFixed(2)}</div>
                                    </td>
                                    <td className="py-6 px-8 text-center">
                                        <span className="px-3 py-1.5 rounded-lg text-xs font-bold bg-white/5 border border-white/5 text-slate-400">{s.currency}</span>
                                    </td>
                                    <td className="py-6 px-8 text-center">
                                        <button
                                            onClick={() => setDeleteId(s.id)}
                                            className="w-10 h-10 rounded-xl flex items-center justify-center text-slate-600 hover:text-red-400 hover:bg-red-500/10 transition-all mx-auto duration-200">
                                            <i className="fa-solid fa-trash-can text-base"></i>
                                        </button>
                                    </td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                    </div>
                </main>

                {/* --- MODALS & NOTIFICATIONS --- */}

                {toastMsg && <Toast msg={toastMsg} />}

                <ConfirmModal
                    isOpen={!!deleteId}
                    onCancel={() => setDeleteId(null)}
                    onConfirm={handleDelete}
                />

                <AddModal
                    isOpen={showAdd}
                    onClose={() => setShowAdd(false)}
                    onSave={handleAdd}
                />
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>